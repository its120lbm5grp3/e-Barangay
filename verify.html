<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Authenticity Checker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f5f6f8;
    padding: 30px;
  }
  h2 { color: #222; }
  input[type="file"], button { margin-top: 20px; }
  video {
    width: 300px;
    height: 300px;
    border: 2px solid #ccc;
    border-radius: 10px;
    margin-top: 15px;
  }
  #result {
    font-size: 1.2em;
    margin-top: 20px;
    font-weight: bold;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnAExXXG9bOB47rO4XnjeNZNmQle9fAPQ",
    authDomain: "qr-checker-38ac1.firebaseapp.com",
    projectId: "qr-checker-38ac1",
    storageBucket: "qr-checker-38ac1.appspot.com",
    messagingSenderId: "888229359713",
    appId: "1:888229359713:web:64bba2b0c6ee057c627a20",
    measurementId: "G-PK22BRPZJC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function extractCode(data) {
    try {
      const url = new URL(data);
      const parts = url.pathname.split('/');
      return parts.pop() || parts[parts.length - 1];
    } catch {
      return data.trim();
    }
  }

  async function checkCode(code) {
    console.log("Checking Firestore for code:", code);
    const resultEl = document.getElementById("result");
    const ref = doc(db, "documents", code);

    try {
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        console.log("Firestore data found:", data);
        resultEl.innerHTML = `Authentic QR Code<br>Product: ${data.productName || "Unnamed Product"}`;
        resultEl.style.color = "green";
      } else {
        console.warn("No document found for", code);
        resultEl.innerHTML = "Not Authentic!";
        resultEl.style.color = "red";
      }
    } catch (error) {
      console.error("Firestore error:", error);
      resultEl.innerHTML = "Error checking Firestore.";
      resultEl.style.color = "red";
    }
  }

  async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const resultEl = document.getElementById("result");
    resultEl.innerHTML = "Scanning image...";
    resultEl.style.color = "black";

    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, img.width, img.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const qr = jsQR(imageData.data, canvas.width, canvas.height);

      if (qr) {
        const code = extractCode(qr.data);
        console.log("QR Detected:", code);
        resultEl.innerHTML = `QR Code: ${code}`;
        resultEl.style.color = "blue";
        checkCode(code);
      } else {
        resultEl.innerHTML = "No QR code found in the image.";
        resultEl.style.color = "red";
      }
    };
  }

  // Camera-based scanning
  let videoStream = null;
  async function startCamera() {
    const video = document.getElementById("camera");
    const resultEl = document.getElementById("result");

    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = videoStream;
      video.play();

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const scan = () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const qr = jsQR(imageData.data, canvas.width, canvas.height);
          if (qr) {
            const code = extractCode(qr.data);
            console.log("QR Detected:", code);
            resultEl.innerHTML = `QR Code: ${code}`;
            resultEl.style.color = "blue";
            checkCode(code);
            stopCamera();
            return;
          }
        }
        requestAnimationFrame(scan);
      };
      scan();
    } catch (err) {
      console.error("Camera access error:", err);
      resultEl.innerHTML = "Cannot access camera.";
      resultEl.style.color = "red";
    }
  }

  function stopCamera() {
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
    }
  }

  window.handleFileUpload = handleFileUpload;
  window.startCamera = startCamera;
  window.stopCamera = stopCamera;
</script>
</head>

<body>
  <h2>QR Code Authenticity Checker</h2>
  <p>Upload a QR code image or use your camera to verify authenticity:</p>

  <input type="file" accept="image/*" onchange="handleFileUpload(event)">
  <br>
  <button onclick="startCamera()">Start Camera Scan</button>
  <button onclick="stopCamera()">Stop Camera</button>
  <br>
  <video id="camera" autoplay></video>

  <p id="result"></p>
</body>
</html>
